# table-tbm Folder

## Files
- `main.py`: A main python file which can be used to call the generator / create testcases. Takes in an argument of how many prefixes to generate code for, which corresponds to reading the first _n_ lines of prefixes from `../bgptable.csv`.
- `tbm_generator.py`: A file that generates P4 code to implement IP lookup based on tree bit map. Called from `main.py`.
- `tbm.p4`: The base p4 file that incorporates the output of `main.py`.
- `send.py`: A file that sends user-inputted content to a specified host.
- `receive.py`: A file that listens on the `eth0` interface for incoming data.
- Use `send.py` and `receive.py` together.
- `tester_send.py`: A file that takes in an argument of how many prefixes to test and sends data to each of those prefixes.
- `tester_receive.py`: A file that takes in an argument of how many prefixes to test and expects to receive data from based on the host it is running on.
- Use `tester_send.py` and `tester_receive.py` together.
- `network_util.py`: Various functions related to IP addresses and parsing the `../bgptable.csv` file.
- `simple-topo/s1-runtime.json`: A file generated by `main.py`; it specifies the table entries to be loaded into the switch at runtime.

## How to use

Run `python3 main.py <num_prefixes>` to generate the ingress logic in `tbm.p4gen`. Then, one option to run the code is to run `p4c tbm.p4` and copy paste the output from `tbm.p4i` into the online P4 sandbox.

Other option is to use Mininet. After generating `tbm.p4gen`, file. run `make` to compile the file and start up Mininet. You'll be dropped into the Mininet CLI.

In the Mininet CLI, open xterm windows for the hosts you want to test. Hosts h1, h2, h3, and h4 are sender nodes that you can run `tester_send.py` on. Hosts h5, h6, h7, and h8 are the next hops specified in `../bgptable.csv`, so run `tester_receive.py` on them. For both `tester_*` files, specify the same number of prefixes that you used when running `main.py`. Make sure you start `tester_receive.py` on all the hosts before running `tester_send.py`. Once all requests have been sent, use ^C to terminate the `tester_receive.py` scripts. When the script is terminated, it will print out if the test was successful or if errors occurred.

## Adding a new host
- Define prefixes for hosts and their corresponding port and MAC address in `main.py`. The ports start from 1.
- In `topology.json`, the IP and MAC needs to match. For the commands, the gateway IP address must be in the host IP's address range, and the MAC address can be anything. Make sure everything matches!
- Run `python3 main.py` to generate the p4gen file.
- Run `make` to start everything up.
- You can also start up Wireshark to inspect packets to confirm everything is appearing as expected.